---
layout: post
title:  "OpenGL学习笔记3"
date:   2020-03-25
categories: 图形学
tags: OpenGL
excerpt: 图形学中的常见变换
author: Tizeng
---

* content
{:toc}

## 变换（Transformations）

这里变换指的是向量在二维或三维空间中缩放（scaling）、位移（translation）、旋转（rotation），都是通过和变换矩阵相乘得到，旋转要复杂一些，对于旋转矩阵LearnOpenGL教程中并没有给出生成的方法，因此我参考了《游戏引擎架构》中的第四章——游戏所需的三维数学，作为补充。

向量的点积可以用来判断两个向量是相同方向还是相反方向，也可以用来求一个点高于或低于平面的高度（给定平面的单位法向量和平面上任意一点的坐标）。

向量的叉积大小为由**a**和**b**构成的平行四边形的面积，叉积运算只定义在三维空间。

两个变换矩阵**A**和**B**相乘得到的仍是一个变换矩阵，与该矩阵进行变换等同于进行**A**和**B**两者的变换。

变换矩阵的逆矩阵可以还原该变换矩阵所做的变换。一个矩阵乘以它的逆矩阵的结果是单位矩阵（对角线元素皆为1，其余元素为0的正方形矩阵），单位矩阵乘以任何其他矩阵，都会得到和原来一样的矩阵。并非所有矩阵都有逆矩阵，但所有仿射矩阵（纯平移、旋转、缩放及切变shear的组合）都有逆矩阵。旋转矩阵的逆矩阵就是该旋转矩阵的转置矩阵。

二维空间中的旋转矩阵用极坐标系的思想很容易推导。

### 伪向量（Pseudovector）

伪矢量指的是在瑕旋转下，除了反射之外，还会再上下翻转的矢量。通常来说伪矢量可以表示为两个向量的叉积，比如一个有向平面的法向量。一个有向平面可以用两个不平行的向量**a**和**b**来定义，向量**a**叉乘**b**垂直此平面，但是与平面垂直的向量有两个，方向相反，具体是哪个根据右手定则确定。许多物理量都是伪矢量，比如由一个电流线圈产生的磁场，如果将其对一个镜面反射之后，电流的流向会相反，但所产生的磁场方向就不是镜面反射，根据右手定则，磁场方向会和原来的方向相反。

瑕旋转：2D平面上以某点作为中心旋转之后，再对某直线做镜面反射。如果是3D空间，应绕某一轴旋转，之后反射的平面需要和旋转轴垂直。

### 齐次坐标（Homogeneous Coordinates）

三维的旋转可以用3x3的旋转矩阵来实现，但是并不能实现平移，这时我们就需要4x4矩阵，当点或矢量从三维延伸到四维，便称为齐次坐标。当用矩阵变换一个方向矢量时，要忽略其平移的效果，因为矢量并没有位置属性，平移也就无意义，因此可以把点的第四个坐标（w分量）设为1，把方向矢量的w分量设为0，这样结果中就不会有平移（坐标相加）的影响。将齐次坐标（四维）转换成非齐次坐标（三维）的方法是，把x、y、z分量分别除以w分量。

### 万向锁（Gimbal Lock）

要解释万向锁，首先要理解欧拉角。这里参考了LearnOpenGL译者Krasjet的[Bonus章节](https://krasjet.github.io/quaternion/bonus_gimbal_lock.pdf)，欧拉角是三维空间中描述旋转的一种方式，任何三维空间中的旋转，都可以拆分为三个正交且经过自身的坐标轴的旋转，欧拉角分别称他们为俯仰角（pitch）、偏航角（yaw）和滚动角（roll）。其中每个旋转都可以写成一个旋转矩阵的形式，将三个旋转矩阵相乘就得到了最终的旋转变换矩阵，要注意它们相乘的顺序很重要，会影响最后的结果，我们一般会选择一个固定的顺序，这就可能导致万向锁。

当使用**动态**欧拉角进行三维空间中的旋转（上面描述的这种旋转），即旋转轴存在层级关系时，可能出现前两个轴的旋转使得某个旋转的维度和最后一个维度重合，这样的话最后一个维度的旋转其实是重复前面某个维度的旋转，也就是说丢失了一个维度，绕三个轴旋转的操作从结果来看只有两个轴。旋转轴不同的层级（父子）关系会出现不同方向的万向锁，通常根据使用的场景选择最少出现万向锁情况的层级关系，以降低其出现的概率，要完全避免这个问题，需要使用四元数。

### 四元数（Quaternion）

这里参考了译者的电子书[四元数与三维旋转](https://krasjet.github.io/quaternion/quaternion.pdf)。为了理解四元数先复习一下复数，二维平面的上的旋转可以用复数来描述，我们把任意一复数$c+di$在复平面上看成向量$[c, d]$，将其与另外一个复数$a+bi$相乘，化简后发现结果和矩阵$[a,-b;b,a]$和$[c;d]$相乘的结果$[ac-bd,bc+ad]$是一样的（实部虚部），因此我们可以将复数相乘表示为矩阵相乘，我们再对ab矩阵提取公因式$\sqrt(a^2 + b^2)$，并假设它为1（模为1，不考虑缩放），则其矩阵可以进一步表示为
$$
\left[\begin{matrix}
\cos\theta & -\sin\theta \\
\sin\theta & \cos\theta \\
\end{matrix}\right]
$$
与$[0, 1]^T$、$[1, 0]^T$相乘可以发现该矩阵让它们在复平面中逆时针旋转了θ度。

四元数和复数类似，只是四元数的虚部有三个分量i、j、k，它们满足
$$i^2=j^2=k^2=ijk=-1$$
上面这个公式决定了四元数的一切性质，任何一个四元数都可以表示为$q=a+bi+cj+dk$，写成向量形式$q=[a, b, c, d]$，我们经常将实部与虚部分开，用一个三维向量表示虚部，这样可以将$q$表示为标量和向量的有序对的形式$q=[s, \mathbf{v}] (\mathbf{v}=[x,y,z])$。

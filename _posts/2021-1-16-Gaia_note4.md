---
layout: post
title: "Gaia笔记4——周版本更新"
date: 2021-1-27
categories: UE4
tags: gaia
excerpt: 版本更新新功能时遇到的问题
author: Tizeng
published: false
---

* content
{:toc}

## TWeakObjectPtr

## GC

之前更换模型很多次之后出现的内存暴涨4G的问题再次出现，尽管已经将更换Mesh改成了Destroy场景中的Actor再读表重新创建，怀疑是多次操作后积累了过多需要gc的资源，导致一次清理时消耗过多内存。

## 系统提示信息（2021.1.28）

最开始我想根据三个枚举值去抽象每个提示消息，第一部分、第二部分、格式，c++把这三个类型通知到lua，然后lua去显示，做完交互的提示就发现这样设计很僵硬，如果提示所需的信息量不只三个，就需要重新定义通知的delegate，而这个不确定因素是不可控的，所以肯定不能这么做。在友哥的建议下先定义一个NoticeBase类，其中定义一个GenerateNoticeContent的接口，需要显示提示的地方根据需求使用相应的派生类

提示出现本该在自己客户端弹出的提示弹到了别人账号上的问题，原因是服务器用GetController得到的PC可能并不是客户端自己的PC，谁需要弹提示就要找到对应的PC去弹。

## 设置界面（2021.2.4）

### 灵敏度等的设置条

可拖动，进度条点按下时进度条

有很多自适应的需求，在搭建小组件蓝图时（如可拖动进度条），过度使用horizontalbox和overlay会影响自适应的效果，造成一些蛋疼的问题，有时候直接另加一个canvas就完了

### 将界面接入灵敏度等设置

摄像机逻辑在GaiaCameraControlComponent中，先理一下触屏控制逻辑，首先在PlayerController（简称pc）的InputComponent上绑定（用BindTouch而非BindAction）了OnTouchMove等回调，例用pc的delegate通知lua处理，有触摸事件后会知道触摸的屏幕location，和此次点击最初的location比较过后，将变化的X值和Y值分别通知pc，pc负责用delegate广播yaw和pitch的变化，需要关心它们变化的component（比如这里的CameraControlComponent）会在BeginPlay时在pc的相应delegate上注册自己的回调函数（监听），然后处理逻辑。

镜头是如何转动的？

* InputComponent是定义在Actor中的成员，Controller本身继承自Actor
* Character和Controller的关系？
* 多播（multicast）delegate指的是能绑定多个函数的delegate，在调用Broadcast后一并执行

### 储存玩家设置

使用引擎中自带的[SaveGame Object](https://docs.unrealengine.com/en-US/InteractiveExperiences/SaveGame/index.html)储存设置信息。

### 滑动条手感优化

ue4自带的Slider的功能很简单，只是一个可以拖动的条，点击其他位置会把thumb从当前位置设置到点击位置，但我们并不想要这样的效果

### 第一次打开设置界面的情况

### 与其他界面的冲突

设置界面打开时会隐藏hud，如果此时玩家死亡并且有复活机会，复活ui会与设置界面重叠，如果玩家复活，hud会因复活被打开，

玩家死亡后可能会出现复活按钮，这部分逻辑原本在c++，现在要移到lua，相当于**c++通知lua**

### 总结

这次做这个界面需要用很多通用组件，如显示数字的滑动条、多项选择条、确认界面等，遇到最多的问题是自适应，当外界大小变化时，有的组件要X方向同时变大，Y方向不变，而有的是部分变部分不变，还有的按比例变，需要活用canvas、scalebox和四角、两边锚点。

调数字位置时与Slider的Handle位置偶尔不能同步，MinValue越大不同步现象越明显，查看源码之后发现SliderValue在处理前减去了MinValue，我想当然的以为他不会去减，导致我计算出的百分比和Slider计算的不一致（能看源码还是好）。

做按下按钮持续增长减少时遇到按钮OnReleased事件不正常触发

滑动条右边mask是一串点点点的图片，直接设置size会使之变形，因此要把image的Tiling设置为horizontal，图片的锚点设在右端，AlignmentX设为1，这样可以在size变化时让其右端不动，从左边开始缩放，但Tiling默认是从左往右填充，没有方向的选项，会有不需要的移动效果，想让其从右往左填充，只需要将其ScaleX设为-1。

很多交互条件是以图片资源的大小为界限，做判断时应该直接去拿相应资源的大小，而不该去手动设置阈值，这样无论图片如何更换效果都保持一致。

widget有一个Clipping设置以前一直没有注意，直到这次发现ScrollBox会裁掉超出区域的ui而VerticalBox不会，查了一下之后才发现原来是可以设置的，ScrollBox默认超出边缘的child都会被裁掉。

lua修改灵敏度数值储存后，需要通知CameraControlComponent，实际上就是**lua通知c++**，在pc中定义一个delegate，注册回调，然后lua在需要时通知时Broadcast就行。

## Batch语法

`set /p VarName=`用来接收prompt输入，并将输入赋给变量。



## 多语言

## Bug合集

* 需要ContextObject的时候把this传入报cannot convert to 'UObject'的错，检查后发现该函数是const，因此this指针也是const，当然不能转了，改成GetWorld()就行了。
* 创建新类时即使有GENERATED_UCLASS_BODY也需要定义Constructor
* FString作为参数传入时记得加*
* 服务器调用一个BlueprintImplementableEvent无法通知到lua，要单独写一个Client函数
* 主干出现一个野指针问题，是我用来储存SaveGameObj的指针，没有用UPROPERTY，导致被gc

---
layout: post
title: "Gaia笔记4——周版本更新"
date: 2021-1-27
categories: UE4
tags: gaia
excerpt: 版本更新新功能时遇到的问题
author: Tizeng
published: false
---

* content
{:toc}

## TWeakObjectPtr

## GC

之前更换模型很多次之后出现的内存暴涨4G的问题再次出现，尽管已经将更换Mesh改成了Destroy场景中的Actor再读表重新创建，怀疑是多次操作后积累了过多需要gc的资源，导致一次清理时消耗过多内存。

## 系统提示信息（2021.1.28）

最开始我想根据三个枚举值去抽象每个提示消息，第一部分、第二部分、格式，c++把这三个类型通知到lua，然后lua去显示，做完交互的提示就发现这样设计很僵硬，如果提示所需的信息量不只三个，就需要重新定义通知的delegate，而这个不确定因素是不可控的，所以肯定不能这么做。在友哥的建议下先定义一个NoticeBase类，其中定义一个GenerateNoticeContent的接口，需要显示提示的地方根据需求使用相应的派生类

提示出现本该在自己客户端弹出的提示弹到了别人账号上的问题，原因是服务器用GetController得到的PC可能并不是客户端自己的PC，谁需要弹提示就要找到对应的PC去弹。 

### 提示信息的配置（2021.4.14）



## 设置界面（2021.2.4）

### 灵敏度等的设置条

UE4有Slider组件作为拖动条，更新和读取值十分方便，但表现很基础，策划需要跟随thumb显示的数字，要实现这个效果，得根据Slider长度和位置计算出thumb的初始位置，然后用其当前百分比算出一个当前位置，并把数字组件设到那个位置，而且每次SliderValue变化的时候都去更新。

有很多自适应的需求，在搭建小组件蓝图时（如可拖动进度条），过度使用Hbox和Overlay会影响自适应的效果，造成一些蛋疼的问题，有时候直接另加一个Canvas就完了。对于需要保持长宽比缩放的widget，可以考虑使用ScaleBox，然后设置合适的四周锚点，或者用其他容器包一下。

### 将界面接入灵敏度等设置

摄像机逻辑在GaiaCameraControlComponent中，先理一下触屏控制逻辑：首先在PlayerController（简称pc）的InputComponent上绑定（用BindTouch而非BindAction）了OnTouchMove等回调，例用pc的delegate通知lua处理，有触摸事件后会知道触摸的屏幕location，和此次点击最初的location比较过后，将变化的X值和Y值分别通知pc，pc负责用delegate广播yaw和pitch的变化，需要关心它们变化的component（比如这里的CameraControlComponent）会在BeginPlay时在pc的相应delegate上注册自己的回调函数（监听），然后处理逻辑。

### 镜头是如何转动的？

### TPS镜头跟随

* InputComponent是定义在Actor中的成员，Controller本身继承自Actor
* Character和Controller的关系？
* 多播（multicast）delegate指的是能绑定多个函数的delegate，在调用Broadcast后一并执行

### 储存玩家设置

使用引擎中自带的[SaveGame Object](https://docs.unrealengine.com/en-US/InteractiveExperiences/SaveGame/index.html)储存设置信息。

### 滑动条手感优化

ue4自带的Slider的功能很简单，只是一个可以拖动的条，点击其他位置会把thumb从当前位置设置到点击位置，但策划并不想要这样的效果

### 第一次打开设置界面的情况

此时会检测不到本地储存的SaveGameObj，直接创建一个，使用默认值初始化ui，然后储存该Obj。

### 与其他界面的冲突

设置界面打开时会隐藏hud，如果此时玩家死亡并且有复活机会，复活ui会与设置界面重叠，如果玩家复活，hud会因复活被打开，这是逻辑出现了冲突，打开设置界面隐藏了HUD，但死亡也会隐藏，然后复活时再打开，要解决这个问题只需要区分隐藏的层级，死亡时并不需要隐藏所有HUD，至少要留下退出按钮，因此只隐藏大部分HUD，而设置界面则隐藏所有HUD，包含死亡隐藏的部分，这样就不会有冲突了。

玩家死亡后可能会出现复活按钮，这部分逻辑原本在c++，现在要移到lua，相当于**c++通知lua**，在PC中定义一个delegate就行，后来发现直接加在死亡通知的delegate里面就行。

### 总结

这次做这个界面需要用很多通用组件，如显示数字的滑动条、多项选择条、确认界面等，遇到最多的问题是自适应，当外界大小变化时，有的组件要X方向同时变大，Y方向不变，而有的是部分变部分不变，还有的按比例变，需要活用canvas、scalebox和四角、两边锚点。

调数字位置时与Slider的Handle位置偶尔不能同步，MinValue越大不同步现象越明显，查看源码之后发现SliderValue在处理前减去了MinValue，我想当然的以为他不会去减，导致我计算出的百分比和Slider计算的不一致（能看源码还是好）。

做按下按钮持续增长减少时遇到按钮OnReleased事件不正常触发，是由于按钮勾选了IsFocusable导致。

滑动条右边mask是一串点点点的图片，直接设置size会使之变形，因此要把image的Tiling设置为horizontal，图片的锚点设在右端，AlignmentX设为1，这样可以在size变化时让其右端不动，从左边开始缩放，但Tiling默认是从左往右填充，没有方向的选项，会有不需要的移动效果，想让其从右往左填充，只需要将其ScaleX设为-1。

很多交互条件是以图片资源的大小为界限，做判断时应该直接去拿相应资源的大小，而不该去手动设置阈值，这样无论图片如何更换效果都保持一致。

widget有一个Clipping设置以前一直没有注意，直到这次发现ScrollBox会裁掉超出区域的ui而VerticalBox不会，查了一下之后才发现原来是可以设置的，ScrollBox默认超出边缘的child都会被裁掉。但其实并没有卵用，因为如果设置成不clip，那里面的内容就会超出ui区域。

lua修改灵敏度数值储存后，需要通知CameraControlComponent，实际上就是**lua通知c++**，在pc中定义一个delegate，注册回调，然后lua在需要时通知时Broadcast就行。

设置界面应该做成按配置去生成grid的形式，否则每次都要写相同的逻辑，之前没有直接这样做的原因一是时间紧来不及，二是美术需要看效果。

## 掉落物整合进交互（2021.3.15）

出现测试场景中没问题但进副本不触发问题，发现是掉落物actor在spawn时会有服务器和客户端区分，归属玩家的掉落由客户端生成，无归属的掉落由服务器生成然后同步给所有人。

掉落客户端表现

## 画质设置（2021.3.25）

## GM命令（2021.3.31）

游戏中按下`\``输入gm命令的实现很简单，只需要在CheatManager中加上对应的方法，输入与方法名一样的名称与参数就会执行，策划另外要求了一套GM面板，点击按钮后会在专门的界面上自动输入对应的gm命令，点击执行后激活功能，这就要求我们自己解析输进去的字符串，并为其绑定函数，同时还要拿到参数，调用时一并传入，传入的方法是将所有参数放进一个table，然后调用函数时直接把这个table传进去。

## 合作信息提示（2021.4.26）

### 队友1保护了队友2

在僵尸死亡时先判断是否满足保护条件（如周围有玩家），如果有则拿到击杀者名字，然后对所有玩家广播信息。这是最早想到的做法，但是弹提示是玩家的行为，与npc无关，所以这部分逻辑应该放在Player做而不是npc做，npc只需要抛出死亡事件，然后玩家监听

## 系统提示优化（2021.4.25）

之前系统提示写的很急，没怎么考虑扩展性和可读性，直接在代码里显式按id读表数据，令人头大。

友哥提供了一个以蓝图为基础的思路，定义Notice类时，将id作为一个成员变量，由外部配置，Generate方法直接用这个id去读表返回内容。为不同的功能派生该类的子类蓝图，在蓝图中配置，然后在需要的地方生成实例，调用Generate方法生成内容，显示提示。比如尸潮提示，尸潮通过触发器触发，触发后会调用OnActive接口函数，我们只需要在这里显示通知就行了，为了知道生成的是哪个类，还需要增加一个蓝图ref变量，然后选择Notice类，再将默认值设置成配置好的子类蓝图，这样生成的实例就可以按我们配置的数据Generate出提示内容，而生成的实现在类的定义中。

## 队友描边（2021.4.29）

中间插的小功能，TA提供了显示角色描边的接口，只需要客户端判断一下是否是自己，然后调用就行。和显示队友头上的名字类似，

## 界面基类、继承、覆写方法

## Batch语法

`set /p VarName=`用来接收prompt输入，并将输入赋给变量。

## 多语言

## Bug合集

* 需要ContextObject的时候把this传入报cannot convert to 'UObject'的错，检查后发现该函数是const，因此this指针也是const，当然不能转了，改成GetWorld()就行了。
* 创建新类时即使有GENERATED_UCLASS_BODY也需要定义Constructor
* FString作为参数传入时记得加*
* 服务器调用一个BlueprintImplementableEvent无法通知到lua，要单独写一个Client函数
* 主干出现一个野指针问题，是我用来储存SaveGameObj的指针，没有用UPROPERTY，导致被gc
* 犯了个错误，把服务器没有开发完全的功能合进了主干，导致若干问题出现

---
layout: post
title: "Gaia笔记3——GAS"
date: 2021-1-16
categories: UE4
tags: GAS
excerpt: ue4中的技能系统框架整理
author: Tizeng
published: false
---

* content
{:toc}

（2022.3.16）ui方面的事情总算告一段落，有时间继续去看技能有关的文档了。

## 什么是GameplayAbilitySystem（GAS）

GAS是虚幻引擎下的一套技能框架插件，它的优势是易于扩展，实现复杂的技能流程，而且支持网络复制，它在EPIC公司内部已经被Fornite登大型的商业联机游戏所使用，开发联机游戏的坑很多都帮你踩过了，避免重复造轮子的麻烦。其中分离的GA、GE模块实现了技能核心逻辑和技能效果的解耦，易于修改和复用，开发时能够专注在某个特定模块，而不是在一个技能中考虑所有事情。

主要参考的资料是[GASDocument](https://github.com/tranek/GASDocumentation)及其中文翻译，还有虚幻官方的[视频介绍](https://www.bilibili.com/video/BV1zD4y1X77M)和GAS入门的[直播录像](https://www.bilibili.com/video/BV1X5411V7jh)。

## GAS的组成

### AbilitySystemComponent（ASC）

要使用GAS的功能就必须为某个Actor挂上ASC，这里面储存了目前激活的GE（`ActiveGameplayEffects`）和GA（`ActivatableAbilities`），在对他们进行遍历时，要加上宏`ABILITYLIST_SCOPE_LOCK`以确保遍历的元素在当前作用域不会被删除，它利用的是本地声明的变量在作用域内的生命周期，在构造和析构中进行了锁定的计数，`ClearAbility`会检查这个计数，只有当计数归零的时候才会去真正清除，否则只是将其保存在一个数组中。

### GameplayTag

这是UE自带的功能，GAS大量使用了tag来实现互斥、加状态、条件判断等。它的特点是用字符串表示的多层级的结构，这样的好处是查找起来可以按层级索引，而不用每个具体的标签都去遍历，而且字符串处理起来也非常简单方便。通常角色身上会有不只一个标签，因此会用`FGameplayTagContainer`来储存各种`FGameplayTag`。

`RegisterGameplayTagEvent`是ASC中监听某个Tag的方法，它接收一个`FGameplayTag`和一个枚举，判断是否只在Tag新增或删除的时候才通知。在ASC中使用`FGameplayTagCountContainer`结构储存了现有的Tag信息，以及更新的接口。

`UAsyncTaskGameplayTagAddedRemoved`中又封装了一层蓝图接口，实现了Tag增加和删除可以注册的操作。

### GameplayAttribute

角色的各种属性，血量、体力、魔法之类，一般只通过GE去控制，其中维护两个值`BaseValue`和`CurrentValue`，主要是为了方便在上buff之后恢复原先的值。出了Instant和Periodic类型的GE改变`BaseValue`，Duration和Infinite类型的GE改变的都是`CurrentValue`。

多个属性可以组成属性集AttributeSet，它提供了一些宏可以直接为每个属性生成Setter、Getter以及Init函数，一般来说属性集会直接放在ASC中统一管理。

### GameplayEffect（GE）

GE是纯配置蓝图，所有相关逻辑都通过配置来完成

技能产生的效果，如伤害、buff、增益、状态。通常用来修改属性。比如连击时，NPC被击杀后给玩家上一个加属性的GE，这个GE将玩家身上的“连击数”这一属性增加若干值，然后使用了`ListenForAttributeChange`的地方就能监听到该属性的改变。

- FGameplayEffectContext：包含激活该GE的GA，释放该GE的Actor（Instigator）等
- FGameplayEffectContextHandle：包含Context的结构，用来支持多态和网络复制，用`MakeEffectContext`生成
- FGameplayEffectSpec：包含GE实例（Def），Context，等级，持续时间等
- FGameplayEffectSpecHandle：包含Spec，可以用`MakeOutgoingSpec`生成，GE直接使用CDO
  
- SetByCaller：一种设置值的方式，代表该值由生成此GE的地方决定
- ExecutionCalculation：可以在GE执行后做一些复杂的属性运算

### GameplayAbility（GA）

GA是技能的核心逻辑，任何行为都可以是GA，除了常见的人物主动释放的技能，还可以是交互、格挡甚至受击，但要注意基础的移动和UI上的交互不宜使用GA，GA通常用来触发某种特定条件下的行为，而不是平时一直会做的事情。

- FGameplayAbilityActorInfo：包含持有该GA的OwnerActor、表现上的AvatarActor等和使用该GA的Actor有关的信息
- FGameplayAbilityActivationInfo：激活状态，是否是Authority，以及预测情况
- FGameplayAbilitySpecHandle：通过一个int32型变量（Handle）区分ASC中特定的GA，全局唯一
- FGameplayAbilitySpec：包含GA的CDO实例、等级、InputId等，同时还包含该GA的激活状态（ActivationInfo），也包含Handle
- FGameplayAbilitySpecDef：包含被GE grant时所需要的信息，可以用来生成Spec

如果要释放一个技能，首先要Give，这样GA（的Spec）才会被加入到`ActivatableAbilities`的数组中，释放的时候一般传入GA类型，然后根据CDO在数组中找到对应的GA，调用`ActivateAbility`。

`CanActivateAbility`：
* 检查Avatar、网络情况（排除Role为Simulated的Avatar）和ASC
* 检查CostGE中的Modifier是否在Apply之后属性值仍都大于0
* 检查cd，看看ASC上有没有该技能的cd标签
* 检查标签是否满足条件
* 检查inputid是否被屏蔽

### GameplayCue

技能的视觉特效，控制技能特效的播放和停止

### GameplayTask

执行异步任务的框架

## 项目应用实例

### 冷却时间（2022.5.9）

在释放技能后，有一段时间内不能再次释放，也就是常说的cd，在GAS框架下，cd的实现是通过为每个GA定义一个专门区分cd的标签，以及cd的时长，然后在玩家身上挂一个GE，通过`SetByCaller`的方式设置其持续时间（Duration），同时将GA上配置的标签也给到该GE，这样就无需重复定义cd用的GE了。
在释放技能走到CommitAbility后会执行`ApplyCooldown`，给玩家上冷却的GE。当前剩余cd时间可以用GetCooldownTimeRemaining等接口通过一个`FGameplayEffectQuery`和ASC和中储存的当前激活的GE进行比对，得到结果后再通过计算当前时间和该GE的开始时间的插值，拿到该GE的剩余持续时间。

### 伤害流程（2022.4.8）

梳理一下从玩家点击射击按钮开始，到开枪，判断是否击中，扣怪的血量的流程。

InputComponent：GameMode初始化游戏时会遍历所有Controller，调用`RestartPlayer`，在起始位置Spawn角色（GameMode中配置了类），进行Possess等操作，最终通知客户端调用`ClientRestart`生成InputComponent。Controller上也会在初始化时生成一个InputComponent，并在子类Controller中绑定各个输入Mapping对应的函数。

绑定输入后按键和ui便可触发WeaponActor上的开枪方法，枪械Actor上的EffectComponent负责生成子弹（即Projectile，子弹的类型通过PropertyComponent来配置配置），子弹的各项属性会事先计算好，然后子弹Actor身上的MoveComponent驱动它移动，检测到碰撞时通过物理材质（Physical Material）的类型可以做一些逻辑判断，如果击中npc则通知玩家的Controller给该npc上一个伤害GE。

GE上的Execution类会处理具体的伤害逻辑，其中需要用到玩家和NPC身上的某些属性，可以在Execution初始化时Capture到。

持续开枪

在Player输入初始化时也可以将输入绑定到ASC。

### NPC受击

### 连击计数实现整理（2021.10.18）

这个功能很多游戏都有，击杀达到一定数量后进入连击状态并倒计时，此时打空扣时间，打中将时间补满，连击状态中每击杀一个怪连击数加1（或其他值），如果倒计时结束，则进行结算。

### NPC跳跃扑倒（2022.5.23）

首先有一个跳跃GA，应该是由行为树释放，有专门配置的伤害GE，和之前的Execution类似的计算，然后是一个用来使玩家倒地的GE，这个GE会让玩家释放一个BeControlled的GA（granted），释放之后玩家就一直播放倒地动画，等控制结束或被打断，就移除这个GE，连带将BeControlled的GA一并移除（Remove Ability On End）。

### 近战攻击


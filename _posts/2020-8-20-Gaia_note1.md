---
layout: post
title: "Gaia笔记1——上手"
date: 2020-07-21
categories: 引擎
tags: ue4
excerpt: ue4入门笔记
author: Tizeng
---

* content
{:toc}

## 背包（2020.8.20）

需要从背包中获取某个类型的道具时，调用BackpackManager的get方法，其中最基础的是一个GetItems方法，它从外部接收一个函数，用来判断哪些道具应该被滤除，通过定义不同的匿名函数作为参数传入，可以很容易的实现GetItemByType和GetAllItems。

ue4中的蓝图如何在脚本中调用，变量如何调用修改？
通过编辑unlua生成的lua模板，控制其中组件的行为，如果组件也是蓝图，要获取其中的变量一样使用`.`操作符

按钮如何注册回调？
对于一个Button组件，在脚本中为它的OnClicked事件注册回调函数。

如何显示、关闭界面？
显示需要拿到Widget蓝图后，用AddToViewport显示，关闭的话直接RemoveFromParent。

如何在umg中调整widget的各种属性?
size和position这类在slot分类下，要调整这些属性先要将组件（如一个image）用Slot as Canvas Slot转换之后才能调整。
创建一个Vector2D使用MakeVector2D，要取xy的值用BreakVector2D。

如何读excel表？
先创建一个符合表数据类型的structure，然后import源文件，并按照我们创建的structure在引擎中生成data table，这是通常的做法。项目中使用了脚本将xslx文件生成为了一个和proto buffer格式一样的类，表中的数据转换成了类中的成员，每个excel就是一个类，然后C++层定义了根据表类型（也就是表名）去拿实例的方法，由于使用了模板，lua层不能直接调用，需要在C++层再封装一个方法给lua。

如何调用C++中模板函数？
在C++层再包一层方法，封装好需要使用的模板类型，直接返回需要的数据，lua层直接调这个方法。

这周（8.31）把美术拼的umg结构重新调整，以便根据需要去动态生成相应的ui。unlua中蓝图的Construct方法要在AddChild后才会调用。

读背包的数据应该由数据层脚本提供，ui层只调用，如果需要controller等比较常用的实例，应该通过Util等脚本的通用接口获取。（9.24）发现ui显示的数据需要从服务器获取而不是读表，只需要把数据层获取的实现改一下就行了，ui层不用动。

需求是选中武器点击装备后，该slot显示对应栏位的ui：
每次装备了道具或新增了道具服务器都会通知客户端刷新界面，刷新时先将显示grid的容器清空，再按服务器给的顺序添加，此时我们已经知道哪些道具已经被装备和其装备的栏位，只需要在创建grid时显示就行了。

属性界面要显示已装备和当前选中道具的对比，如果没有装备则直接显示选中的装备：
数据层负责拿属性数据，属性ui脚本负责刷新和显示，上层ui界面响应点击，那么判断是否需要显示对比的ui应该放在哪里去判断？想来想去感觉还是应该放到创建属性ui的方法中去判断，因为取当前选中道具数据的接口不应该关心现在装备了什么道具。
发现还是不行，之前设计生成属性ui的方法只关心数据而不关心是什么属性，所以要拿已装备武器的什么属性来对比对属性ui来说是未知的，还是得在数据层去取，然后填入属性数据中，属性ui刷新的时候去查看有没有需要对比的属性值（即已装备的值），来决定要不要进行对比，这样才比较合理。

十个按钮，响应的事件非常类似，只是根据不同种类的道具进入相应的界面，除了为每个按钮注册单独的方法特殊处理之外有更好的方法吗？（9.18）
封装一个蓝图widget，只包含一个按钮，然后自己定义一个event，为其定义需要传入的参数如index，然后将蓝图中定义好的变量在call时告知event。这样如果有很多按钮触发的事件很类似，就只用为它们注册同一个回调，然后根据传入的index执行不同的逻辑，减少冗余的代码。

## RPC（Romote Procedure Call）

是一种客户端与服务器通信的方法，不同于传统的C->S、S->C基于协议收发消息，服务器在C++层定义了消息的结构和s->c、c->s的方法，客户端请求时是根据事先约定好的id去通知服务器去调用相应的方法，服务器调用结束后再将结果返回给客户端，客户端再通知umg或unlua中重写的方法去处理逻辑。

## Bug合集

* 更改ui蓝图后依然调用了以前蓝图的unlua脚本，检查接口实现，没问题已经改过，后来发现原因是该ui在更改接口之前被加入了另一个umg中，相当于实例没有更新。
* 设置字体颜色的时候总是失败，按umg里的结构先创建了linear color，然后创建slate color，最后用slate color去SetColorAndOpacity，发现怎么设置都是默认的紫色，能想到的有两个原因，一是颜色创建有问题，二是颜色创建成功传入SetColorAndOpacity方法时有问题，排查后发现是slate color无法正常创建，其LinearColor成员SpecifiedColor始终没有被赋值，只能手动去覆盖（居然想了很久都没有想到这样去解决）。
